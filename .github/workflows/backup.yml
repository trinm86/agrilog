name: Weekly Supabase Backup

on:
  schedule:
    - cron: '0 0 * * 0' # Tự động chạy lúc 0h00 Chủ Nhật hàng tuần
  workflow_dispatch:      # Nút bấm chạy tay để test ngay

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Tự động cài Prisma 5.13.0 ngay trong môi trường chạy để đảm bảo đồng bộ
      - name: Setup Prisma Environment
        run: |
          npm init -y
          npm install prisma@5.13.0 @prisma/client@5.13.0
          if [ -f "prisma/schema.prisma" ]; then
            npx prisma generate
          fi

      - name: Run Database Backup
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Đang xử lý kết nối tới region ap-south-1..."
          
          # Tự động xóa pgbouncer=true để pg_dump không báo lỗi URI
          # Tự động đảm bảo dùng cổng 6543 để backup ổn định nhất
          CLEAN_URL=$(echo $DATABASE_URL | sed 's/[?&]pgbouncer=true//g' | sed 's/:5432/:6543/g')
          
          docker run --rm \
            postgres:17-alpine \
            psql "$CLEAN_URL" -t -A -c "COPY (SELECT COALESCE(json_agg(t), '[]'::json) FROM (SELECT * FROM caytrong) t) TO STDOUT" > caytrong.json

      - name: Commit and Push changes
        run: |
          # Cấu hình user để GitHub biết ai là người commit
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Kiểm tra xem file có thay đổi không để tránh lỗi commit trống
          git add caytrong.json
          if git diff --staged --quiet; then
            echo "Dữ liệu không có thay đổi, bỏ qua commit."
          else
            git commit -m "Update caytrong.json [$(date +'%Y-%m-%d %H:%M:%S')]"
            git push origin main
          fi
