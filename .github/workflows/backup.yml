name: Weekly Supabase Backup

on:
  schedule:
    - cron: '0 0 * * 0' # Tự động chạy 00:00 Chủ Nhật hàng tuần
  workflow_dispatch:      # Bấm nút chạy tay để kiểm tra ngay

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Bước này cài đặt Prisma ngay tại môi trường GitHub để đồng bộ hóa
      - name: Setup Node.js and Prisma
        run: |
          npm init -y
          npm install prisma@5.13.0 @prisma/client@5.13.0
          # Nếu bồ có file schema.prisma, nó sẽ generate client tại đây
          if [ -f "prisma/schema.prisma" ]; then
            npx prisma generate
          fi

      - name: Run Database Backup
        env:
          # Bồ dán chuỗi có &pgbouncer=true vào Secret tên là DATABASE_URL
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          CLEAN_URL=$(echo $DATABASE_URL | sed 's/[?&]pgbouncer=true//g')
          echo "Đang kết nối và sao lưu dữ liệu qua Pooler..."
          
          # Sử dụng Docker để lấy công cụ pg_dump chuẩn
          docker run --rm \
            postgres:15-alpine \
            pg_dump "$CLEAN_URL" \
            --no-owner \
            --clean \
            --if-exists \
            -v \
            -F p > backup_$(date +%Y%m%d).sql

      - name: Save Backup to GitHub Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: supabase-backup
          path: backup_*.sql
          retention-days: 30
